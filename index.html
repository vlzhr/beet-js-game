<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Borscht.Beet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!--<script src="pixi/pixi.min.js"></script>-->
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <script src="pixi/keyboard.js"></script>
    <script src="pixi/collision.js"></script>
    <script src="Steve.js"></script>
    <script src="Background.js"></script>
    <script src="Coin.js"></script>
    <script src="Enemy.js"></script>
    <link rel="stylesheet" href="basic.css">
</head>
<body>
<script>
    //Aliases
    let Application = PIXI.Application,
        Container = PIXI.Container,
        Graphics = PIXI.Graphics,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite;

    //Create a Pixi Application
    let app = new Application({
            width: window.innerWidth,
            height: window.innerHeight,
            antialiasing: true,
            backgroundColor: 0x1099bb,
            transparent: 'notMultiplied',
            resolution: 1
        }
    );


    document.body.appendChild(app.view);

    loader
        .add("images/knife.png").add("images/meat-grinder.png").add("images/coin.png")
        .add("ill/state-1.json")
        .add("ill/state-2.json")
        .add("images/background/static.png").add("images/background/1.png").add("images/background/2.png").add("images/background/3.png").add("images/background/4.png")
        .load(setup);

    let beet, healthBar, sheet, enemies=[], barriers=[];
    let left;

    function setup() {

        // background settings
        staticBg = new StaticBackground("images/background/static.png");

        bg = [
            new Background("images/background/1.png", 0.5),
            new Background("images/background/2.png", 1),
            new Background("images/background/3.png", 1.5),
            new Background("images/background/4.png", 2)
        ];



        // main hero settings
        textureArray = [];

        for (const i in PIXI.loader.resources["ill/state-1.json"].data.frames)//(let i=0; i < 3; i++)
        {
            let texture = PIXI.Texture.fromFrame(i);
            textureArray.push(texture);
        }
        for (const i2 in PIXI.loader.resources["ill/state-2.json"].data.frames)//(let i=0; i < 3; i++)
        {
            let texture2 = PIXI.Texture.fromFrame(i2);
            textureArray.push(texture2);
        }

        beet = new MultiAnimatedSprite(textureArray, {
            "boost": {"states": [3,4,5], "loop": false, "scale": 0.25},
            "default": {"states": [0,1,2], "loop": true, "scale": 0.25}
        });
        beet.animationSpeed = 0.1;

        // beet.height = 60;
        // beet.width = 120;
        beet.x = 150;
        beet.y = 200;
        beet.vy = 0;
        beet.gravity = -5;
        app.stage.addChild(beet);


        // enemies setting
        enemies.push(new Enemy());
        setTimeout(() => { enemies.push(new Enemy()); }, 700);
        setTimeout(() => { enemies.push(new Enemy()); }, 1400);

        barriers.push(new Barrier());


        // coins settings
        coins = new CoinsRaw();


        // control settings
        left = leftMouse(0);
        t = touch();
        leftArrow = keyboard(37);
        leftArrow.press= left.press = t.press = function() {
            beet.playAnimation("boost");
            beet.vy = 12;
        };
        leftArrow.release = left.release = t.release = function() {
            beet.vy = beet.vy * 0.8;
            setTimeout(() => {beet.vy = beet.vy * 0.6;}, 150);
            setTimeout(() => {beet.vy = 0;}, 300);
        };


        //Create the health bar
        healthBar = new Container();
        healthBar.position.set(app.stage.width - 170, 4);
        app.stage.addChild(healthBar);

        //Create the black background rectangle
        let innerBar = new Graphics();
        innerBar.beginFill(0x000000);
        innerBar.drawRect(0, 0, 128, 38);
        innerBar.endFill();
        healthBar.addChild(innerBar);

        //Create the front red rectangle
        let outerBar = new Graphics();
        outerBar.beginFill(0xFF3300);
        outerBar.drawRect(0, 0, 128, 38);
        outerBar.endFill();
        healthBar.addChild(outerBar);
        healthBar.outer = outerBar;



        app.ticker.add(delta => gameLoop(delta));  // runs function gameLoop 60 times per sec
    }

    function checkCollision() {
        enemies.forEach(function(enemy) {

            if(hitRectangle(beet, enemy)) {
                healthBar.outer.width -= 1;
                return true;
            }

        });
        return false;
    }

    function gameLoop(delta){

        let beetXPlusFactor = 1.3;
        let wasBoosted = false;

        // main hero movement
        if (beet.y - beet.gravity >= 20 ) {
            if (beet.vy > 0) { beetXPlusFactor = 1.3; wasBoosted = true; }
            beet.y -= beet.vy;
        }
        if (beet.y - beet.gravity <= app.renderer.height - 20 - beet.height ) {
            beet.y -= beet.gravity;

            if (!wasBoosted) { beet.toDefault(); }
        }

        for (let n in enemies) {
            const x = enemies[n];
            x.x -= x.speed * beetXPlusFactor;
            if (x.x <= -x.width) {
                enemies[n] = new Enemy();
            }
        }

        for (let n in barriers) {
            const x = barriers[n];
            x.move(beetXPlusFactor);
            if (x.elements[0].x <= -x.elements[0].width) {
                barriers[n] = new Barrier();
            }
        }

        checkCollision();

        for (let b of bg) { b.nextStep(beetXPlusFactor); }
        coins.nextStep(beetXPlusFactor);

        // animation

    }


</script>
</body>
</html>
